PROGRAM STANDALONE
IMPLICIT NONE

!     Explanation
!     --------
!           Standalone to compute the zonal without perturbation fields for the article called:
!           Analytical and adaptable initial conditions for dry and moist baroclinic waves
!           in the global hydrostatic model OpenIFS (CY43R3)

!     Author.
!     -------
!        C. BOUVIER

INTEGER, PARAMETER :: INT_KIND = SELECTED_INT_KIND(18)  ! Use 18 or another appropriate value
INTEGER(INT_KIND), PARAMETER :: NLAT = 320
INTEGER(INT_KIND), PARAMETER :: NLEV = 137
INTEGER(INT_KIND), PARAMETER :: ZN = 3
INTEGER(INT_KIND), PARAMETER :: KTESTCASE = 42
REAL(KIND=16), PARAMETER :: ZB = 2.0
REAL(KIND=16), PARAMETER :: ZRH0 = 0.8
REAL(KIND=16), PARAMETER :: ZT0 = 288.0
REAL(KIND=16), PARAMETER :: ZU0 = 35.0
REAL(KIND=16), PARAMETER :: ZGAMMA = 0.005

INTEGER(INT_KIND), PARAMETER :: BIN_LIM = 4*ZN+4
INTEGER(INT_KIND), PARAMETER :: GAM_LIM = 2*ZN+3

CHARACTER(LEN=200), PARAMETER :: FILENAME = '/N/slate/jmelms/projects/FCN_dynamical_testing/data/initial_conditions/raw_generated/zonal_fields.csv'

CALL COMPUTE_AND_WRITE_FIELDS(NLAT, NLEV, ZN, ZB, ZT0, ZU0, ZRH0, ZGAMMA, KTESTCASE, BIN_LIM, GAM_LIM, FILENAME)

END PROGRAM STANDALONE

SUBROUTINE COMPUTE_AND_WRITE_FIELDS(NLAT, NLEV, ZN, ZB, ZT0, ZU0, ZRH0, ZGAMMA, KTESTCASE, BIN_LIM, GAM_LIM, FILENAME)

IMPLICIT NONE

!     Explanation
!     --------
!           Subroutine to compute the zonal fields for the article called:
!           Analytical and adaptable initial conditions for dry and moist baroclinic waves 
!           in the global hydrostatic model OpenIFS (CY43R3)

!     Author.
!     -------
!        C. BOUVIER

INTEGER, PARAMETER :: INT_KIND = SELECTED_INT_KIND(18)  ! Use 18 or another appropriate value
INTEGER(INT_KIND), INTENT(IN) :: NLAT, NLEV, ZN, KTESTCASE, BIN_LIM, GAM_LIM
REAL(KIND=16), INTENT(IN) :: ZB, ZT0, ZU0, ZRH0, ZGAMMA
CHARACTER(LEN=200), INTENT(IN) :: FILENAME

REAL(KIND=16) :: VETAF(NLEV), GELAT_DEG(NLAT), GELAT(NLAT)
REAL(KIND=16) :: BINOMIAL(0:BIN_LIM,0:BIN_LIM)
REAL(KIND=16) :: GAM(0:GAM_LIM)
REAL(KIND=16) :: ZPHI_PRIME(NLAT,NLEV)
REAL(KIND=16) :: ZPHI_F(NLAT,NLEV)
REAL(KIND=16) :: ZU(NLAT,NLEV)
REAL(KIND=16) :: ZV(NLAT,NLEV)
REAL(KIND=16) :: ZTV(NLAT,NLEV)
REAL(KIND=16) :: ZTI(NLAT,NLEV)
REAL(KIND=16) :: ZT(NLAT,NLEV)
REAL(KIND=16) :: ZES(NLAT,NLEV)
REAL(KIND=16) :: ZWS(NLAT,NLEV)
REAL(KIND=16) :: ZQ(NLAT,NLEV)
REAL(KIND=16) :: ZPHIVERT(NLEV)
REAL(KIND=16) :: ZTVERT(NLEV)
REAL(KIND=16) :: ZRH(NLEV)

INTEGER(INT_KIND) :: JLEV, JLAT, JN, JK, JI, JOPTI
REAL(KIND=16) :: RPI, ROMEGA, RA, R, RSIDAY, RD, RDAY, RMD, RSIYEA, RG
REAL(KIND=16) :: ZLONC, ZLATC, ZLAPS, ZA
REAL(KIND=16) :: ZCOSLAT, ZSINLAT, ZUSTAR, ZUSTAR_PRIME
REAL(KIND=16) :: F1, F2, F3, F4

VETAF = [9.869232667160129e-06, 2.5166543301258325e-05, 3.82926227485813e-05, 5.674808783617074e-05, &
&        8.181593881075746e-05, 0.0001152726375524303, 0.00015899333826794966, 0.0002151492721440908, &
&        0.0002861090550209721, 0.00037433999506538367, 0.0004828028620774735, 0.0006142610412040463, &
&        0.0007718726868985936, 0.0009588946459412781, 0.0011785837651122624, 0.0014344929681717248, &
&        0.0017301751788798422, 0.002069084628670121, 0.002454971625956082, 0.0028914877868245746, &
&        0.003382186035035776, 0.003930816679003207, 0.004540833950160375, 0.0052159881569208, &
&        0.005959832223044658, 0.006775622995312114, 0.007667012089810017, 0.008637157660991858, &
&        0.0096893165556378, 0.010826844312854675, 0.012052603010115964, 0.013369750801875155, &
&        0.014781149765605725, 0.016289563286454478, 0.01789765605724155, 0.019608290155440414, &
&        0.021423735504564518, 0.023346656797433998, 0.0253793239575623, 0.027524006908462868, &
&        0.029782975573649152, 0.032158203799654575, 0.0346519615099926, 0.0372660251665433, &
&        0.0400020725388601, 0.042860794473229706, 0.04584238835430546, 0.048946656797434, &
&        0.05217310634098199, 0.05552104613866272, 0.05899047619047619, 0.06258583765112263, &
&        0.06631542067604244, 0.07018869972859611, 0.07421653096471749, 0.07841065877128053, &
&        0.08278470268936591, 0.08735376264495436, 0.09213195164075993, 0.0971294349864298, &
&        0.10235381199111769, 0.10781317542561066, 0.11351571675302245, 0.11946962743646682, &
&        0.1256833950160375, 0.1321658031088083, 0.13892553663952628, 0.14597167530224525, &
&        0.15331339748334566, 0.16095998026153469, 0.16892089810017272, 0.17720572415494695, &
&        0.1858245250431779, 0.19478697261287933, 0.2041034295583518, 0.21378396249691586, &
&        0.2238391315075253, 0.23427949666913397, 0.2451156180606958, 0.2563585492227979, &
&        0.2680191463113743, 0.2801085615593388, 0.2926380458919319, 0.305618948926721, &
&        0.3190628176659264, 0.33298119911176904, 0.34738583765112263, 0.3622885763631878, &
&        0.37770125832716506, 0.3936359240069085, 0.41010481125092524, 0.4271198618307427, &
&        0.444693609671848, 0.4628381939304219, 0.4815662472242783, 0.5008656303972366, &
&        0.5206707130520603, 0.5408647421662965, 0.5613301751788798, 0.5819686158401185, &
&        0.6026791018998272, 0.6233598815692081, 0.6439105847520356, 0.664234098198865, &
&        0.6842381445842586, 0.7038372563533185, 0.7229533678756477, 0.7415174932149025, &
&        0.7594699235134469, 0.7767607204539847, 0.7933503084135208, 0.8092081914631137, &
&        0.8243136442141624, 0.8386546262028127, 0.8522269923513447, 0.8650339995065385, &
&        0.8770852208240809, 0.8883956575376265, 0.8989849494201825, 0.9088766839378238, &
&        0.9180970145571182, 0.9266747594374538, 0.9346400197384653, 0.9420240809277078, &
&        0.9488587219343696, 0.9551754256106588, 0.9610058721934369, 0.9663806563039724, &
&        0.9713300764865531, 0.9758828522082408, 0.9800668147051567, 0.9839084135208488, &
&        0.9874330125832717, 0.9906642980508266, 0.9936244756970145, 0.9963348630643968, &
&        0.9988150999259807]

GELAT_DEG = [89.57008955,  89.01317613,  88.45297384,  87.89202845,  87.33080118, &
&            86.76943751,  86.20799762,  85.64651085,  85.0849932,   84.52345415, &
&            83.96189965,  83.40033364,  82.83875882,  82.27717711,  81.71558991, &
&            81.15399827,  80.59240298,  80.03080465,  79.46920377,  78.90760074, &
&            78.34599585,  77.78438937,  77.2227815,   76.66117243,  76.09956229, &
&            75.53795121,  74.9763393,   74.41472665,  73.85311333,  73.29149941, &
&            72.72988495,  72.16827,     71.60665461,  71.04503881,  70.48342264, &
&            69.92180614,  69.36018932,  68.79857221,  68.23695484,  67.67533723, &
&            67.11371939,  66.55210134,  65.9904831,   65.42886467,  64.86724608, &
&            64.30562732,  63.74400842,  63.18238938,  62.62077021,  62.05915092, &
&            61.49753151,  60.93591199,  60.37429237,  59.81267266,  59.25105285, &
&            58.68943296,  58.12781298,  57.56619293,  57.00457281,  56.44295261, &
&            55.88133235,  55.31971203,  54.75809164,  54.1964712,   53.63485071, &
&            53.07323016,  52.51160957,  51.94998892,  51.38836824,  50.8267475, &
&            50.26512673,  49.70350592,  49.14188507,  48.58026418,  48.01864326, &
&            47.45702231,  46.89540132,  46.33378031,  45.77215926,  45.21053819, &
&            44.64891709,  44.08729596,  43.52567481,  42.96405363,  42.40243243, &
&            41.84081121,  41.27918996,  40.7175687,   40.15594741,  39.59432611, &
&            39.03270478,  38.47108344,  37.90946208,  37.34784071,  36.78621932, &
&            36.22459791,  35.66297649,  35.10135505,  34.5397336,   33.97811214, &
&            33.41649066,  32.85486917,  32.29324767,  31.73162615,  31.17000463, &
&            30.60838309,  30.04676154,  29.48513998,  28.92351842,  28.36189684, &
&            27.80027525,  27.23865366,  26.67703205,  26.11541044,  25.55378882, &
&            24.99216719,  24.43054555,  23.86892391,  23.30730226,  22.7456806, &
&            22.18405893,  21.62243726,  21.06081558,  20.4991939,   19.93757221, &
&            19.37595052,  18.81432882,  18.25270711,  17.6910854,   17.12946369, &
&            16.56784197,  16.00622025,  15.44459852,  14.88297679,  14.32135506, &
&            13.75973332,  13.19811157,  12.63648983,  12.07486808,  11.51324633, &
&            10.95162457,  10.39000282,  9.82838106,   9.26675929,   8.70513753, &
&            8.14351576,   7.581894,     7.02027223,   6.45865045,   5.89702868, &
&            5.33540691,   4.77378513,   4.21216335,   3.65054157,   3.08891979, &
&            2.52729801,   1.96567623,   1.40405445,   0.84243267,   0.28081089, &
&           -0.28081089,  -0.84243267,  -1.40405445,  -1.96567623,  -2.52729801, &
&           -3.08891979,  -3.65054157,  -4.21216335,  -4.77378513,  -5.33540691, &
&           -5.89702868,  -6.45865045,  -7.02027223,  -7.581894,    -8.14351576, &
&           -8.70513753,  -9.26675929,  -9.82838106, -10.39000282, -10.95162457, &
&          -11.51324633, -12.07486808, -12.63648983, -13.19811157, -13.75973332, &
&          -14.32135506, -14.88297679, -15.44459852, -16.00622025, -16.56784197, &
&          -17.12946369, -17.6910854,  -18.25270711, -18.81432882, -19.37595052, &
&          -19.93757221, -20.4991939,  -21.06081558, -21.62243726, -22.18405893, &
&          -22.7456806,  -23.30730226, -23.86892391, -24.43054555, -24.99216719, &
&          -25.55378882, -26.11541044, -26.67703205, -27.23865366, -27.80027525, &
&          -28.36189684, -28.92351842, -29.48513998, -30.04676154, -30.60838309, &
&          -31.17000463, -31.73162615, -32.29324767, -32.85486917, -33.41649066, &
&          -33.97811214, -34.5397336,  -35.10135505, -35.66297649, -36.22459791, &
&          -36.78621932, -37.34784071, -37.90946208, -38.47108344, -39.03270478, &
&          -39.59432611, -40.15594741, -40.7175687,  -41.27918996, -41.84081121, &
&          -42.40243243, -42.96405363, -43.52567481, -44.08729596, -44.64891709, &
&          -45.21053819, -45.77215926, -46.33378031, -46.89540132, -47.45702231, &
&          -48.01864326, -48.58026418, -49.14188507, -49.70350592, -50.26512673, &
&          -50.8267475,  -51.38836824, -51.94998892, -52.51160957, -53.07323016, &
&          -53.63485071, -54.1964712,  -54.75809164, -55.31971203, -55.88133235, &
&          -56.44295261, -57.00457281, -57.56619293, -58.12781298, -58.68943296, &
&          -59.25105285, -59.81267266, -60.37429237, -60.93591199, -61.49753151, &
&          -62.05915092, -62.62077021, -63.18238938, -63.74400842, -64.30562732, &
&          -64.86724608, -65.42886467, -65.9904831,  -66.55210134, -67.11371939, &
&          -67.67533723, -68.23695484, -68.79857221, -69.36018932, -69.92180614, &
&          -70.48342264, -71.04503881, -71.60665461, -72.16827,    -72.72988495, &
&          -73.29149941, -73.85311333, -74.41472665, -74.9763393,  -75.53795121, &
&          -76.09956229, -76.66117243, -77.2227815,  -77.78438937, -78.34599585, &
&          -78.90760074, -79.46920377, -80.03080465, -80.59240298, -81.15399827, &
&          -81.71558991, -82.27717711, -82.83875882, -83.40033364, -83.96189965, &
&          -84.52345415, -85.0849932,  -85.64651085, -86.20799762, -86.76943751, &
&          -87.33080118, -87.89202845, -88.45297384, -89.01317613, -89.57008955]

GELAT = [1.56329297,  1.553573,    1.54379563,  1.53400528,  1.52421002,  1.51441237, &
&        1.5046134,   1.49481361,  1.48501328,  1.47521257,  1.4654116,   1.45561042, &
&        1.44580909,  1.43600764,  1.42620609,  1.41640447,  1.40660278,  1.39680104, &
&        1.38699926,  1.37719744,  1.36739558,  1.3575937,   1.34779179,  1.33798987, &
&        1.32818792,  1.31838596,  1.30858398,  1.29878199,  1.28897999,  1.27917798, &
&        1.26937596,  1.25957393,  1.24977189,  1.23996984,  1.23016779,  1.22036574, &
&        1.21056367,  1.20076161,  1.19095953,  1.18115746,  1.17135538,  1.16155329, &
&        1.15175121,  1.14194911,  1.13214702,  1.12234492,  1.11254283,  1.10274072, &
&        1.09293862,  1.08313651,  1.07333441,  1.0635323,   1.05373019,  1.04392807, &
&        1.03412596,  1.02432384,  1.01452172,  1.0047196,   0.99491748,  0.98511536, &
&        0.97531324,  0.96551112,  0.95570899,  0.94590687,  0.93610474,  0.92630261, &
&        0.91650048,  0.90669835,  0.89689622,  0.88709409,  0.87729196,  0.86748983, &
&        0.8576877,   0.84788556,  0.83808343,  0.82828129,  0.81847916,  0.80867702, &
&        0.79887488,  0.78907275,  0.77927061,  0.76946847,  0.75966633,  0.7498642, &
&        0.74006206,  0.73025992,  0.72045778,  0.71065564,  0.7008535,   0.69105136, &
&        0.68124921,  0.67144707,  0.66164493,  0.65184279,  0.64204065,  0.6322385, &
&        0.62243636,  0.61263422,  0.60283207,  0.59302993,  0.58322779,  0.57342564, &
&        0.5636235,   0.55382135,  0.54401921,  0.53421706,  0.52441492,  0.51461277, &
&        0.50481063,  0.49500848,  0.48520634,  0.47540419,  0.46560204,  0.4557999, &
&        0.44599775,  0.4361956,   0.42639346,  0.41659131,  0.40678916,  0.39698702, &
&        0.38718487,  0.37738272,  0.36758058,  0.35777843,  0.34797628,  0.33817413, &
&        0.32837198,  0.31856984,  0.30876769,  0.29896554,  0.28916339,  0.27936124, &
&        0.2695591,   0.25975695,  0.2499548,   0.24015265,  0.2303505,   0.22054835, &
&        0.2107462,   0.20094406,  0.19114191,  0.18133976,  0.17153761,  0.16173546, &
&        0.15193331,  0.14213116,  0.13232901,  0.12252686,  0.11272472,  0.10292257, &
&        0.09312042,  0.08331827,  0.07351612,  0.06371397,  0.05391182,  0.04410967, &
&        0.03430752,  0.02450537,  0.01470322,  0.00490107, -0.00490107, -0.01470322, &
&       -0.02450537, -0.03430752, -0.04410967, -0.05391182, -0.06371397, -0.07351612, &
&       -0.08331827, -0.09312042, -0.10292257, -0.11272472, -0.12252686, -0.13232901, &
&       -0.14213116, -0.15193331, -0.16173546, -0.17153761, -0.18133976, -0.19114191, &
&       -0.20094406, -0.2107462,  -0.22054835, -0.2303505,  -0.24015265, -0.2499548, &
&       -0.25975695, -0.2695591,  -0.27936124, -0.28916339, -0.29896554, -0.30876769, &
&       -0.31856984, -0.32837198, -0.33817413, -0.34797628, -0.35777843, -0.36758058, &
&       -0.37738272, -0.38718487, -0.39698702, -0.40678916, -0.41659131, -0.42639346, &
&       -0.4361956,  -0.44599775, -0.4557999,  -0.46560204, -0.47540419, -0.48520634, &
&       -0.49500848, -0.50481063, -0.51461277, -0.52441492, -0.53421706, -0.54401921, &
&       -0.55382135, -0.5636235,  -0.57342564, -0.58322779, -0.59302993, -0.60283207, &
&       -0.61263422, -0.62243636, -0.6322385,  -0.64204065, -0.65184279, -0.66164493, &
&       -0.67144707, -0.68124921, -0.69105136, -0.7008535,  -0.71065564, -0.72045778, &
&       -0.73025992, -0.74006206, -0.7498642,  -0.75966633, -0.76946847, -0.77927061, &
&       -0.78907275, -0.79887488, -0.80867702, -0.81847916, -0.82828129, -0.83808343, &
&       -0.84788556, -0.8576877,  -0.86748983, -0.87729196, -0.88709409, -0.89689622, &
&       -0.90669835, -0.91650048, -0.92630261, -0.93610474, -0.94590687, -0.95570899, &
&       -0.96551112, -0.97531324, -0.98511536, -0.99491748, -1.0047196,  -1.01452172, &
&       -1.02432384, -1.03412596, -1.04392807, -1.05373019, -1.0635323,  -1.07333441, &
&       -1.08313651, -1.09293862, -1.10274072, -1.11254283, -1.12234492, -1.13214702, &
&       -1.14194911, -1.15175121, -1.16155329, -1.17135538, -1.18115746, -1.19095953, &
&       -1.20076161, -1.21056367, -1.22036574, -1.23016779, -1.23996984, -1.24977189, &
&       -1.25957393, -1.26937596, -1.27917798, -1.28897999, -1.29878199, -1.30858398, &
&       -1.31838596, -1.32818792, -1.33798987, -1.34779179, -1.3575937,  -1.36739558, &
&       -1.37719744, -1.38699926, -1.39680104, -1.40660278, -1.41640447, -1.42620609, &
&       -1.43600764, -1.44580909, -1.45561042, -1.4654116,  -1.47521257, -1.48501328, &
&       -1.49481361, -1.5046134,  -1.51441237, -1.52421002, -1.53400528, -1.54379563, &
&       -1.553573,   -1.56329297]

RPI=2.0*ASIN(1.0)
R=8.3145
RDAY=86400.0
RMD=28.9644
RSIYEA=365.25*RDAY*2.0*RPI/6.283076
RSIDAY=RDAY/(1.0+RDAY/RSIYEA)
RA=6371229.0
ROMEGA=2.0*RPI/RSIDAY
RD=(1000.0*R)/RMD
RG=9.80665

IF((KTESTCASE == 41) .OR. (KTESTCASE == 42)) THEN

  ZLONC=RPI/9.0
  ZLATC=2.0*RPI/9.0

! Combinatory calculus

  WRITE(*,*) "BEGIN COMBINATORY COMPUTING"

  BINOMIAL(0,0)=1.0
  DO JN=1,4*ZN+2
    BINOMIAL(JN,0)=1.0
    DO JK=1,JN
      IF (JK .EQ. JN) THEN
        BINOMIAL(JN,JK)=1.0
      ELSE
        BINOMIAL(JN,JK)=1.0
        DO JI=0,JK-1
          BINOMIAL(JN,JK)=(BINOMIAL(JN,JK)*(JN-JI))/(JI+1)
        ENDDO
      ENDIF
    ENDDO
  ENDDO

  GAM(0)=SQRT(RPI)
  DO JN=1,2*ZN+1
    GAM(JN)=(BINOMIAL(2*JN,JN)*SQRT(RPI))/(4**JN)
  ENDDO

  WRITE(*,*) "END COMBINATORY COMPUTING"

! Temperature & Geopotential, vert. profiles

  ZLAPS = RD*ZGAMMA/RG

  DO JLEV=1,NLEV
    ZTVERT(JLEV)=ZT0*(VETAF(JLEV)**ZLAPS)
    ZPHIVERT(JLEV)=((ZT0*RG)/ZGAMMA)*(1.0-(VETAF(JLEV)**ZLAPS))
  ENDDO

! Begin the field computation

  WRITE(*,*) "BEGIN SPECTRAL COMPUTING"

  DO JLAT=1,NLAT
    ZCOSLAT=cos(GELAT(JLAT))
    ZSINLAT=sin(GELAT(JLAT))

    F1=(ZCOSLAT**(2.0*ZN+1.0))/(2.0*ZN+1.0)
    F3=(GAM(ZN+1)*SQRT(RPI))/(2.0*ZN+1.0)
    DO JN=1,ZN
      F1=F1 + (((-1.0)**JN)/(2.0*(JN+ZN)+1.0))* &
&	(ZCOSLAT**(2.0*(JN+ZN)+1.0))*BINOMIAL(ZN,JN)
      F3=F3 + (((-1.0)**JN)/(2.0*(JN+ZN)+1.0))* &
&	SQRT(RPI)*BINOMIAL(ZN,JN)*GAM(ZN+JN+1)
    ENDDO

    F2=(ZSINLAT**(4.0*ZN+2.0))/(4.0*ZN+2.0)
    F4=2.0/((4.0*ZN+2.0)*(4.0*ZN+3.0))
    DO JN=1,2*ZN-1
      F2=F2 + (((-1.0)**JN)/(2.0*(JN+2.0*ZN+1.0)))* &
&	(ZSINLAT**(2.0*(JN+2.0*ZN+1.0)))*BINOMIAL(2*ZN-1,JN)
      F4=F4 + ((2.0*(-1.0)**JN)/((2.0*(2.0*ZN+JN+1.0))* &
&	(2.0*(JN+2.0*ZN+1.0)+1.0)))*BINOMIAL(2*ZN-1,JN)
    ENDDO

!   Prescribe wind and temperature

    DO JLEV=1,NLEV
      ZUSTAR=ZU0*log(VETAF(JLEV))*exp(-((log(VETAF(JLEV))/ZB)**2.0))

      ZUSTAR_PRIME=ZU0*exp(-((log(VETAF(JLEV))/ZB)**2.0)) * &
&	((2.0*(log(VETAF(JLEV))/ZB)**2.0)-1.0)

      ZU(JLAT,JLEV) = (-1)*ZUSTAR * &
&	(sin(2.0*GELAT(JLAT))**(2.0*ZN))

      ZV(JLAT,JLEV) = 0.00

      ZPHI_PRIME(JLAT,JLEV) = ZUSTAR*(ROMEGA*RA*(4.0**ZN)*(F3-2.0*F1) + &
&	ZUSTAR*(16.0**ZN)*(0.50*F4-F2))

      ZT(JLAT,JLEV) = ZTVERT(JLEV) + &
&	(ZUSTAR_PRIME/RD)*(ROMEGA*RA*(4.0**ZN)*(F3-2.0*F1) + &
&	ZUSTAR*(16.0**ZN)*(F4-2.0*F2))

      ZPHI_F(JLAT,JLEV) = ZPHIVERT(JLEV) + ZPHI_PRIME(JLAT,JLEV)

    ENDDO
  ENDDO

  WRITE(*,*) "END SPECTRAL COMPUTING"

  DO JLAT = 1,NLAT
    DO JLEV = 1, NLEV
      ZQ(JLAT,JLEV) = 0.00
    ENDDO
  ENDDO

  IF((KTESTCASE == 42)) THEN
!   Compute virtual temperature

    DO JLAT = 1,NLAT
      DO JLEV = 1, NLEV
        ZTV(JLAT,JLEV) = ZT(JLAT,JLEV)
      ENDDO
    ENDDO

    DO JOPTI = 1,10
      DO JLAT = 1,NLAT
        DO JLEV = 1, NLEV
          ZTI(JLAT,JLEV) = ZT(JLAT,JLEV)

          ZES(JLAT,JLEV) = 611.210*exp((17.670*(ZTI(JLAT,JLEV)-273.150)) / &
&           (ZTI(JLAT,JLEV)-29.650))

          ZWS(JLAT,JLEV) = (0.6220*ZES(JLAT,JLEV))/(101325.0*VETAF(JLEV) - &
&           ZES(JLAT,JLEV))

          IF (VETAF(JLEV) .LE. 0.10) THEN
            ZRH(JLEV) = 0.0
          ELSEIF ((VETAF(JLEV) .GT. 0.10) .AND. &
&                 (VETAF(JLEV) .LE. 0.30)) THEN
            ZRH(JLEV) = (0.70*ZRH0/2.0) * &
&             (10.0*VETAF(JLEV)-1.0)
          ELSEIF ((VETAF(JLEV) .GT. 0.30) .AND. &
&                 (VETAF(JLEV) .LE. 0.80)) THEN
            ZRH(JLEV) = 0.70*ZRH0
          ELSE
            ZRH(JLEV) = 0.70*ZRH0 + (0.30*ZRH0/2.0) * &
&             (10.0*VETAF(JLEV)-8.0)
          ENDIF

          ZQ(JLAT,JLEV) = (ZWS(JLAT,JLEV)*ZRH(JLEV))/(ZWS(JLAT,JLEV)*ZRH(JLEV) + &
&           1.0)

          ZT(JLAT,JLEV)=ZTV(JLAT,JLEV)/(1.0+0.6080*ZQ(JLAT,JLEV))

        ENDDO
      ENDDO
    ENDDO
    WRITE(*,*) "END OF MOISTURE for NTESTCASE=42"
  ENDIF
ENDIF

CALL WRITE_FIELDS_TO_CSV(NLAT, NLEV, ZPHI_F, ZU, ZT, ZQ, FILENAME)

END SUBROUTINE COMPUTE_AND_WRITE_FIELDS

SUBROUTINE WRITE_FIELDS_TO_CSV(NLAT, NLEV, ZPHI_F, ZU, ZT, ZQ, FILENAME)
  IMPLICIT NONE

  INTEGER, PARAMETER :: INT_KIND = SELECTED_INT_KIND(18)  ! Use 18 or another appropriate value
  INTEGER(INT_KIND), INTENT(IN) :: NLAT, NLEV
  REAL(KIND=16), INTENT(IN) :: ZPHI_F(NLAT, NLEV), ZU(NLAT, NLEV), ZT(NLAT, NLEV), ZQ(NLAT, NLEV)
  INTEGER(INT_KIND) :: I, J
  CHARACTER(LEN=200) :: FILENAME
  INTEGER(INT_KIND), PARAMETER :: MAX_FILENAME_LEN = 200
  CHARACTER(LEN=255) :: HEADER
  INTEGER(INT_KIND) :: UNIT

  ! Open the file
  OPEN(UNIT=UNIT, FILE=FILENAME, STATUS="NEW")


  ! Define the header row for the CSV file (testing 1st and 2nd levels, 1-3rd lats)
  HEADER = "LAT,LEV,ZPHI_F,ZU,ZT,ZQ"
  ! Write the header row
  WRITE(UNIT, '(A)') HEADER

  DO I = 1, NLEV
    DO J = 1, NLAT ! upper model level inclusion -> segfaults, don't ask me why
      
      WRITE(UNIT, '(I4, I4, F20.10, F20.10, F20.10, F20.10)') I-1, J-1, ZPHI_F(J, I), ZU(J, I), ZT(J, I), ZQ(J, I) ! LAT=J, LEV=I, using zero indexing

    END DO
  END DO

  ! Close the file
  CLOSE(UNIT)

END SUBROUTINE WRITE_FIELDS_TO_CSV