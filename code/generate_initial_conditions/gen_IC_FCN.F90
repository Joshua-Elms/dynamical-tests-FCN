PROGRAM STANDALONE
IMPLICIT NONE

!     Explanation
!     --------
!           Standalone to compute the zonal without perturbation fields for the article called:
!           Analytical and adaptable initial conditions for dry and moist baroclinic waves
!           in the global hydrostatic model OpenIFS (CY43R3)

!     Author.
!     -------
!        C. BOUVIER

! Define variables to hold command-line arguments
INTEGER, PARAMETER :: INT_KIND = SELECTED_INT_KIND(18)  ! Use 18 or another appropriate value
INTEGER(INT_KIND) :: NLAT, NLEV, BIN_LIM, GAM_LIM, ZN, MOISTURE
REAL(KIND=16) :: ZB, ZRH0, ZT0, ZU0, ZGAMMA
CHARACTER(LEN=200) :: FILENAME
CHARACTER(LEN=200) :: ARG

! Check if the correct number of command-line arguments is provided
IF (COMMAND_ARGUMENT_COUNT() /= 10) THEN
   PRINT*, 'Usage: ./gen_init_condition NLAT NLEV ZN ZB ZRH0 ZT0 ZU0 ZGAMMA MOISTURE FILENAME'
   STOP
END IF

  ! Parse command-line arguments
CALL GET_COMMAND_ARGUMENT(1, ARG)
READ(ARG, *) NLAT
CALL GET_COMMAND_ARGUMENT(2, ARG)
READ(ARG, *) NLEV
CALL GET_COMMAND_ARGUMENT(3, ARG)
READ(ARG, *) ZN
CALL GET_COMMAND_ARGUMENT(4, ARG)
READ(ARG, *) ZB
CALL GET_COMMAND_ARGUMENT(5, ARG)
READ(ARG, *) ZRH0
CALL GET_COMMAND_ARGUMENT(6, ARG)
READ(ARG, *) ZT0
CALL GET_COMMAND_ARGUMENT(7, ARG)
READ(ARG, *) ZU0
CALL GET_COMMAND_ARGUMENT(8, ARG)
READ(ARG, *) ZGAMMA
CALL GET_COMMAND_ARGUMENT(9, ARG)
READ(ARG, *) MOISTURE
CALL GET_COMMAND_ARGUMENT(10, FILENAME)

BIN_LIM = 4*ZN+4
GAM_LIM = 2*ZN+3

CALL COMPUTE_AND_WRITE_FIELDS(NLAT, NLEV, ZN, ZB, ZT0, ZU0, ZRH0, ZGAMMA, MOISTURE, BIN_LIM, GAM_LIM, FILENAME)
WRITE(*,*) "Fields written to file ", TRIM(FILENAME)

END PROGRAM STANDALONE

SUBROUTINE COMPUTE_AND_WRITE_FIELDS(NLAT, NLEV, ZN, ZB, ZT0, ZU0, ZRH0, ZGAMMA, KTESTCASE, BIN_LIM, GAM_LIM, FILENAME)

IMPLICIT NONE

!     Explanation
!     --------
!           Subroutine to compute the zonal fields for the article called:
!           Analytical and adaptable initial conditions for dry and moist baroclinic waves 
!           in the global hydrostatic model OpenIFS (CY43R3)

!     Author.
!     -------
!        C. BOUVIER
!        Additions: Joshua Elms

INTEGER, PARAMETER :: INT_KIND = SELECTED_INT_KIND(18)  ! Use 18 or another appropriate value
INTEGER(INT_KIND), INTENT(IN) :: NLAT, NLEV, ZN, KTESTCASE, BIN_LIM, GAM_LIM
REAL(KIND=16), INTENT(IN) :: ZB, ZT0, ZU0, ZRH0, ZGAMMA
CHARACTER(LEN=200), INTENT(IN) :: FILENAME

REAL(KIND=16) :: VETAF(NLEV), GELAT_DEG(NLAT), GELAT(NLAT)
REAL(KIND=16) :: BINOMIAL(0:BIN_LIM,0:BIN_LIM)
REAL(KIND=16) :: GAM(0:GAM_LIM)
REAL(KIND=16) :: ZPHI_PRIME(NLAT,NLEV)
REAL(KIND=16) :: ZPHI_F(NLAT,NLEV)
REAL(KIND=16) :: ZU(NLAT,NLEV)
REAL(KIND=16) :: ZV(NLAT,NLEV)
REAL(KIND=16) :: ZTV(NLAT,NLEV)
REAL(KIND=16) :: ZTI(NLAT,NLEV)
REAL(KIND=16) :: ZT(NLAT,NLEV)
REAL(KIND=16) :: ZES(NLAT,NLEV)
REAL(KIND=16) :: ZWS(NLAT,NLEV)
REAL(KIND=16) :: ZQ(NLAT,NLEV)
REAL(KIND=16) :: ZPHIVERT(NLEV)
REAL(KIND=16) :: ZTVERT(NLEV)
REAL(KIND=16) :: ZRH(NLEV)

INTEGER(INT_KIND) :: JLEV, JLAT, JN, JK, JI, JOPTI
REAL(KIND=16) :: RPI, ROMEGA, RA, R, RSIDAY, RD, RDAY, RMD, RSIYEA, RG
REAL(KIND=16) :: ZLONC, ZLATC, ZLAPS, ZA
REAL(KIND=16) :: ZCOSLAT, ZSINLAT, ZUSTAR, ZUSTAR_PRIME
REAL(KIND=16) :: F1, F2, F3, F4

VETAF = [1.000000000000000E+00, 9.869232667160130E-01, &
&        9.129040217123120E-01, 8.388847767086109E-01, &
&        7.401924500370100E-01, 6.908462867012090E-01, &
&        5.921539600296080E-01, 4.934616333580060E-01, &
&        3.947693066864050E-01, 2.960769800148040E-01, &
&        2.467308166790030E-01, 1.973846533432030E-01, &
&        1.480384900074020E-01, 9.869232667160099E-02, &
&        4.934616333580100E-02]

GELAT_DEG = [90.00, 89.75, 89.50, 89.25, 89.00, 88.75, 88.50, 88.25, &
&            88.00, 87.75, 87.50, 87.25, 87.00, 86.75, 86.50, 86.25, &
&            86.00, 85.75, 85.50, 85.25, 85.00, 84.75, 84.50, 84.25, &
&            84.00, 83.75, 83.50, 83.25, 83.00, 82.75, 82.50, 82.25, &
&            82.00, 81.75, 81.50, 81.25, 81.00, 80.75, 80.50, 80.25, &
&            80.00, 79.75, 79.50, 79.25, 79.00, 78.75, 78.50, 78.25, &
&            78.00, 77.75, 77.50, 77.25, 77.00, 76.75, 76.50, 76.25, &
&            76.00, 75.75, 75.50, 75.25, 75.00, 74.75, 74.50, 74.25, &
&            74.00, 73.75, 73.50, 73.25, 73.00, 72.75, 72.50, 72.25, &
&            72.00, 71.75, 71.50, 71.25, 71.00, 70.75, 70.50, 70.25, &
&            70.00, 69.75, 69.50, 69.25, 69.00, 68.75, 68.50, 68.25, &
&            68.00, 67.75, 67.50, 67.25, 67.00, 66.75, 66.50, 66.25, &
&            66.00, 65.75, 65.50, 65.25, 65.00, 64.75, 64.50, 64.25, &
&            64.00, 63.75, 63.50, 63.25, 63.00, 62.75, 62.50, 62.25, &
&            62.00, 61.75, 61.50, 61.25, 61.00, 60.75, 60.50, 60.25, &
&            60.00, 59.75, 59.50, 59.25, 59.00, 58.75, 58.50, 58.25, &
&            58.00, 57.75, 57.50, 57.25, 57.00, 56.75, 56.50, 56.25, &
&            56.00, 55.75, 55.50, 55.25, 55.00, 54.75, 54.50, 54.25, &
&            54.00, 53.75, 53.50, 53.25, 53.00, 52.75, 52.50, 52.25, &
&            52.00, 51.75, 51.50, 51.25, 51.00, 50.75, 50.50, 50.25, &
&            50.00, 49.75, 49.50, 49.25, 49.00, 48.75, 48.50, 48.25, &
&            48.00, 47.75, 47.50, 47.25, 47.00, 46.75, 46.50, 46.25, &
&            46.00, 45.75, 45.50, 45.25, 45.00, 44.75, 44.50, 44.25, &
&            44.00, 43.75, 43.50, 43.25, 43.00, 42.75, 42.50, 42.25, &
&            42.00, 41.75, 41.50, 41.25, 41.00, 40.75, 40.50, 40.25, &
&            40.00, 39.75, 39.50, 39.25, 39.00, 38.75, 38.50, 38.25, &
&            38.00, 37.75, 37.50, 37.25, 37.00, 36.75, 36.50, 36.25, &
&            36.00, 35.75, 35.50, 35.25, 35.00, 34.75, 34.50, 34.25, &
&            34.00, 33.75, 33.50, 33.25, 33.00, 32.75, 32.50, 32.25, &
&            32.00, 31.75, 31.50, 31.25, 31.00, 30.75, 30.50, 30.25, &
&            30.00, 29.75, 29.50, 29.25, 29.00, 28.75, 28.50, 28.25, &
&            28.00, 27.75, 27.50, 27.25, 27.00, 26.75, 26.50, 26.25, &
&            26.00, 25.75, 25.50, 25.25, 25.00, 24.75, 24.50, 24.25, &
&            24.00, 23.75, 23.50, 23.25, 23.00, 22.75, 22.50, 22.25, &
&            22.00, 21.75, 21.50, 21.25, 21.00, 20.75, 20.50, 20.25, &
&            20.00, 19.75, 19.50, 19.25, 19.00, 18.75, 18.50, 18.25, &
&            18.00, 17.75, 17.50, 17.25, 17.00, 16.75, 16.50, 16.25, &
&            16.00, 15.75, 15.50, 15.25, 15.00, 14.75, 14.50, 14.25, &
&            14.00, 13.75, 13.50, 13.25, 13.00, 12.75, 12.50, 12.25, &
&            12.00, 11.75, 11.50, 11.25, 11.00, 10.75, 10.50, 10.25, &
&            10.00, 9.75, 9.50, 9.25, 9.00, 8.75, 8.50, 8.25, &
&            8.00, 7.75, 7.50, 7.25, 7.00, 6.75, 6.50, 6.25, &
&            6.00, 5.75, 5.50, 5.25, 5.00, 4.75, 4.50, 4.25, &
&            4.00, 3.75, 3.50, 3.25, 3.00, 2.75, 2.50, 2.25, &
&            2.00, 1.75, 1.50, 1.25, 1.00, 0.75, 0.50, 0.25, &
&            0.00, -0.25, -0.50, -0.75, -1.00, -1.25, -1.50, -1.75, &
&            -2.00, -2.25, -2.50, -2.75, -3.00, -3.25, -3.50, -3.75, &
&            -4.00, -4.25, -4.50, -4.75, -5.00, -5.25, -5.50, -5.75, &
&            -6.00, -6.25, -6.50, -6.75, -7.00, -7.25, -7.50, -7.75, &
&            -8.00, -8.25, -8.50, -8.75, -9.00, -9.25, -9.50, -9.75, &
&            -10.00, -10.25, -10.50, -10.75, -11.00, -11.25, -11.50, -11.75, &
&            -12.00, -12.25, -12.50, -12.75, -13.00, -13.25, -13.50, -13.75, &
&            -14.00, -14.25, -14.50, -14.75, -15.00, -15.25, -15.50, -15.75, &
&            -16.00, -16.25, -16.50, -16.75, -17.00, -17.25, -17.50, -17.75, &
&            -18.00, -18.25, -18.50, -18.75, -19.00, -19.25, -19.50, -19.75, &
&            -20.00, -20.25, -20.50, -20.75, -21.00, -21.25, -21.50, -21.75, &
&            -22.00, -22.25, -22.50, -22.75, -23.00, -23.25, -23.50, -23.75, &
&            -24.00, -24.25, -24.50, -24.75, -25.00, -25.25, -25.50, -25.75, &
&            -26.00, -26.25, -26.50, -26.75, -27.00, -27.25, -27.50, -27.75, &
&            -28.00, -28.25, -28.50, -28.75, -29.00, -29.25, -29.50, -29.75, &
&            -30.00, -30.25, -30.50, -30.75, -31.00, -31.25, -31.50, -31.75, &
&            -32.00, -32.25, -32.50, -32.75, -33.00, -33.25, -33.50, -33.75, &
&            -34.00, -34.25, -34.50, -34.75, -35.00, -35.25, -35.50, -35.75, &
&            -36.00, -36.25, -36.50, -36.75, -37.00, -37.25, -37.50, -37.75, &
&            -38.00, -38.25, -38.50, -38.75, -39.00, -39.25, -39.50, -39.75, &
&            -40.00, -40.25, -40.50, -40.75, -41.00, -41.25, -41.50, -41.75, &
&            -42.00, -42.25, -42.50, -42.75, -43.00, -43.25, -43.50, -43.75, &
&            -44.00, -44.25, -44.50, -44.75, -45.00, -45.25, -45.50, -45.75, &
&            -46.00, -46.25, -46.50, -46.75, -47.00, -47.25, -47.50, -47.75, &
&            -48.00, -48.25, -48.50, -48.75, -49.00, -49.25, -49.50, -49.75, &
&            -50.00, -50.25, -50.50, -50.75, -51.00, -51.25, -51.50, -51.75, &
&            -52.00, -52.25, -52.50, -52.75, -53.00, -53.25, -53.50, -53.75, &
&            -54.00, -54.25, -54.50, -54.75, -55.00, -55.25, -55.50, -55.75, &
&            -56.00, -56.25, -56.50, -56.75, -57.00, -57.25, -57.50, -57.75, &
&            -58.00, -58.25, -58.50, -58.75, -59.00, -59.25, -59.50, -59.75, &
&            -60.00, -60.25, -60.50, -60.75, -61.00, -61.25, -61.50, -61.75, &
&            -62.00, -62.25, -62.50, -62.75, -63.00, -63.25, -63.50, -63.75, &
&            -64.00, -64.25, -64.50, -64.75, -65.00, -65.25, -65.50, -65.75, &
&            -66.00, -66.25, -66.50, -66.75, -67.00, -67.25, -67.50, -67.75, &
&            -68.00, -68.25, -68.50, -68.75, -69.00, -69.25, -69.50, -69.75, &
&            -70.00, -70.25, -70.50, -70.75, -71.00, -71.25, -71.50, -71.75, &
&            -72.00, -72.25, -72.50, -72.75, -73.00, -73.25, -73.50, -73.75, &
&            -74.00, -74.25, -74.50, -74.75, -75.00, -75.25, -75.50, -75.75, &
&            -76.00, -76.25, -76.50, -76.75, -77.00, -77.25, -77.50, -77.75, &
&            -78.00, -78.25, -78.50, -78.75, -79.00, -79.25, -79.50, -79.75, &
&            -80.00, -80.25, -80.50, -80.75, -81.00, -81.25, -81.50, -81.75, &
&            -82.00, -82.25, -82.50, -82.75, -83.00, -83.25, -83.50, -83.75, &
&            -84.00, -84.25, -84.50, -84.75, -85.00, -85.25, -85.50, -85.75, &
&            -86.00, -86.25, -86.50, -86.75, -87.00, -87.25, -87.50, -87.75, &
&            -88.00, -88.25, -88.50, -88.75, -89.00, -89.25, -89.50, -89.75, &
&            -90.00]

GELAT = [1.57079633, 1.56643300, 1.56206968, 1.55770636, 1.55334303, &
&        1.54897971, 1.54461639, 1.54025306, 1.53588974, 1.53152642, &
&        1.52716310, 1.52279977, 1.51843645, 1.51407313, 1.50970980, &
&        1.50534648, 1.50098316, 1.49661983, 1.49225651, 1.48789319, &
&        1.48352986, 1.47916654, 1.47480322, 1.47043989, 1.46607657, &
&        1.46171325, 1.45734993, 1.45298660, 1.44862328, 1.44425996, &
&        1.43989663, 1.43553331, 1.43116999, 1.42680666, 1.42244334, &
&        1.41808002, 1.41371669, 1.40935337, 1.40499005, 1.40062672, &
&        1.39626340, 1.39190008, 1.38753676, 1.38317343, 1.37881011, &
&        1.37444679, 1.37008346, 1.36572014, 1.36135682, 1.35699349, &
&        1.35263017, 1.34826685, 1.34390352, 1.33954020, 1.33517688, &
&        1.33081355, 1.32645023, 1.32208691, 1.31772359, 1.31336026, &
&        1.30899694, 1.30463362, 1.30027029, 1.29590697, 1.29154365, &
&        1.28718032, 1.28281700, 1.27845368, 1.27409035, 1.26972703, &
&        1.26536371, 1.26100038, 1.25663706, 1.25227374, 1.24791042, &
&        1.24354709, 1.23918377, 1.23482045, 1.23045712, 1.22609380, &
&        1.22173048, 1.21736715, 1.21300383, 1.20864051, 1.20427718, &
&        1.19991386, 1.19555054, 1.19118721, 1.18682389, 1.18246057, &
&        1.17809725, 1.17373392, 1.16937060, 1.16500728, 1.16064395, &
&        1.15628063, 1.15191731, 1.14755398, 1.14319066, 1.13882734, &
&        1.13446401, 1.13010069, 1.12573737, 1.12137404, 1.11701072, &
&        1.11264740, 1.10828408, 1.10392075, 1.09955743, 1.09519411, &
&        1.09083078, 1.08646746, 1.08210414, 1.07774081, 1.07337749, &
&        1.06901417, 1.06465084, 1.06028752, 1.05592420, 1.05156087, &
&        1.04719755, 1.04283423, 1.03847090, 1.03410758, 1.02974426, &
&        1.02538094, 1.02101761, 1.01665429, 1.01229097, 1.00792764, &
&        1.00356432, 0.99920100, 0.99483767, 0.99047435, 0.98611103, &
&        0.98174770, 0.97738438, 0.97302106, 0.96865773, 0.96429441, &
&        0.95993109, 0.95556777, 0.95120444, 0.94684112, 0.94247780, &
&        0.93811447, 0.93375115, 0.92938783, 0.92502450, 0.92066118, &
&        0.91629786, 0.91193453, 0.90757121, 0.90320789, 0.89884456, &
&        0.89448124, 0.89011792, 0.88575460, 0.88139127, 0.87702795, &
&        0.87266463, 0.86830130, 0.86393798, 0.85957466, 0.85521133, &
&        0.85084801, 0.84648469, 0.84212136, 0.83775804, 0.83339472, &
&        0.82903139, 0.82466807, 0.82030475, 0.81594143, 0.81157810, &
&        0.80721478, 0.80285146, 0.79848813, 0.79412481, 0.78976149, &
&        0.78539816, 0.78103484, 0.77667152, 0.77230819, 0.76794487, &
&        0.76358155, 0.75921822, 0.75485490, 0.75049158, 0.74612826, &
&        0.74176493, 0.73740161, 0.73303829, 0.72867496, 0.72431164, &
&        0.71994832, 0.71558499, 0.71122167, 0.70685835, 0.70249502, &
&        0.69813170, 0.69376838, 0.68940505, 0.68504173, 0.68067841, &
&        0.67631509, 0.67195176, 0.66758844, 0.66322512, 0.65886179, &
&        0.65449847, 0.65013515, 0.64577182, 0.64140850, 0.63704518, &
&        0.63268185, 0.62831853, 0.62395521, 0.61959188, 0.61522856, &
&        0.61086524, 0.60650192, 0.60213859, 0.59777527, 0.59341195, &
&        0.58904862, 0.58468530, 0.58032198, 0.57595865, 0.57159533, &
&        0.56723201, 0.56286868, 0.55850536, 0.55414204, 0.54977871, &
&        0.54541539, 0.54105207, 0.53668874, 0.53232542, 0.52796210, &
&        0.52359878, 0.51923545, 0.51487213, 0.51050881, 0.50614548, &
&        0.50178216, 0.49741884, 0.49305551, 0.48869219, 0.48432887, &
&        0.47996554, 0.47560222, 0.47123890, 0.46687557, 0.46251225, &
&        0.45814893, 0.45378561, 0.44942228, 0.44505896, 0.44069564, &
&        0.43633231, 0.43196899, 0.42760567, 0.42324234, 0.41887902, &
&        0.41451570, 0.41015237, 0.40578905, 0.40142573, 0.39706240, &
&        0.39269908, 0.38833576, 0.38397244, 0.37960911, 0.37524579, &
&        0.37088247, 0.36651914, 0.36215582, 0.35779250, 0.35342917, &
&        0.34906585, 0.34470253, 0.34033920, 0.33597588, 0.33161256, &
&        0.32724923, 0.32288591, 0.31852259, 0.31415927, 0.30979594, &
&        0.30543262, 0.30106930, 0.29670597, 0.29234265, 0.28797933, &
&        0.28361600, 0.27925268, 0.27488936, 0.27052603, 0.26616271, &
&        0.26179939, 0.25743606, 0.25307274, 0.24870942, 0.24434610, &
&        0.23998277, 0.23561945, 0.23125613, 0.22689280, 0.22252948, &
&        0.21816616, 0.21380283, 0.20943951, 0.20507619, 0.20071286, &
&        0.19634954, 0.19198622, 0.18762289, 0.18325957, 0.17889625, &
&        0.17453293, 0.17016960, 0.16580628, 0.16144296, 0.15707963, &
&        0.15271631, 0.14835299, 0.14398966, 0.13962634, 0.13526302, &
&        0.13089969, 0.12653637, 0.12217305, 0.11780972, 0.11344640, &
&        0.10908308, 0.10471976, 0.10035643, 0.09599311, 0.09162979, &
&        0.08726646, 0.08290314, 0.07853982, 0.07417649, 0.06981317, &
&        0.06544985, 0.06108652, 0.05672320, 0.05235988, 0.04799655, &
&        0.04363323, 0.03926991, 0.03490658, 0.03054326, 0.02617994, &
&        0.02181662, 0.01745329, 0.01308997, 0.00872665, 0.00436332, &
&        0.00000000, -0.00436332, -0.00872665, -0.01308997, -0.01745329, &
&        -0.02181662, -0.02617994, -0.03054326, -0.03490658, -0.03926991, &
&        -0.04363323, -0.04799655, -0.05235988, -0.05672320, -0.06108652, &
&        -0.06544985, -0.06981317, -0.07417649, -0.07853982, -0.08290314, &
&        -0.08726646, -0.09162979, -0.09599311, -0.10035643, -0.10471976, &
&        -0.10908308, -0.11344640, -0.11780972, -0.12217305, -0.12653637, &
&        -0.13089969, -0.13526302, -0.13962634, -0.14398966, -0.14835299, &
&        -0.15271631, -0.15707963, -0.16144296, -0.16580628, -0.17016960, &
&        -0.17453293, -0.17889625, -0.18325957, -0.18762289, -0.19198622, &
&        -0.19634954, -0.20071286, -0.20507619, -0.20943951, -0.21380283, &
&        -0.21816616, -0.22252948, -0.22689280, -0.23125613, -0.23561945, &
&        -0.23998277, -0.24434610, -0.24870942, -0.25307274, -0.25743606, &
&        -0.26179939, -0.26616271, -0.27052603, -0.27488936, -0.27925268, &
&        -0.28361600, -0.28797933, -0.29234265, -0.29670597, -0.30106930, &
&        -0.30543262, -0.30979594, -0.31415927, -0.31852259, -0.32288591, &
&        -0.32724923, -0.33161256, -0.33597588, -0.34033920, -0.34470253, &
&        -0.34906585, -0.35342917, -0.35779250, -0.36215582, -0.36651914, &
&        -0.37088247, -0.37524579, -0.37960911, -0.38397244, -0.38833576, &
&        -0.39269908, -0.39706240, -0.40142573, -0.40578905, -0.41015237, &
&        -0.41451570, -0.41887902, -0.42324234, -0.42760567, -0.43196899, &
&        -0.43633231, -0.44069564, -0.44505896, -0.44942228, -0.45378561, &
&        -0.45814893, -0.46251225, -0.46687557, -0.47123890, -0.47560222, &
&        -0.47996554, -0.48432887, -0.48869219, -0.49305551, -0.49741884, &
&        -0.50178216, -0.50614548, -0.51050881, -0.51487213, -0.51923545, &
&        -0.52359878, -0.52796210, -0.53232542, -0.53668874, -0.54105207, &
&        -0.54541539, -0.54977871, -0.55414204, -0.55850536, -0.56286868, &
&        -0.56723201, -0.57159533, -0.57595865, -0.58032198, -0.58468530, &
&        -0.58904862, -0.59341195, -0.59777527, -0.60213859, -0.60650192, &
&        -0.61086524, -0.61522856, -0.61959188, -0.62395521, -0.62831853, &
&        -0.63268185, -0.63704518, -0.64140850, -0.64577182, -0.65013515, &
&        -0.65449847, -0.65886179, -0.66322512, -0.66758844, -0.67195176, &
&        -0.67631509, -0.68067841, -0.68504173, -0.68940505, -0.69376838, &
&        -0.69813170, -0.70249502, -0.70685835, -0.71122167, -0.71558499, &
&        -0.71994832, -0.72431164, -0.72867496, -0.73303829, -0.73740161, &
&        -0.74176493, -0.74612826, -0.75049158, -0.75485490, -0.75921822, &
&        -0.76358155, -0.76794487, -0.77230819, -0.77667152, -0.78103484, &
&        -0.78539816, -0.78976149, -0.79412481, -0.79848813, -0.80285146, &
&        -0.80721478, -0.81157810, -0.81594143, -0.82030475, -0.82466807, &
&        -0.82903139, -0.83339472, -0.83775804, -0.84212136, -0.84648469, &
&        -0.85084801, -0.85521133, -0.85957466, -0.86393798, -0.86830130, &
&        -0.87266463, -0.87702795, -0.88139127, -0.88575460, -0.89011792, &
&        -0.89448124, -0.89884456, -0.90320789, -0.90757121, -0.91193453, &
&        -0.91629786, -0.92066118, -0.92502450, -0.92938783, -0.93375115, &
&        -0.93811447, -0.94247780, -0.94684112, -0.95120444, -0.95556777, &
&        -0.95993109, -0.96429441, -0.96865773, -0.97302106, -0.97738438, &
&        -0.98174770, -0.98611103, -0.99047435, -0.99483767, -0.99920100, &
&        -1.00356432, -1.00792764, -1.01229097, -1.01665429, -1.02101761, &
&        -1.02538094, -1.02974426, -1.03410758, -1.03847090, -1.04283423, &
&        -1.04719755, -1.05156087, -1.05592420, -1.06028752, -1.06465084, &
&        -1.06901417, -1.07337749, -1.07774081, -1.08210414, -1.08646746, &
&        -1.09083078, -1.09519411, -1.09955743, -1.10392075, -1.10828408, &
&        -1.11264740, -1.11701072, -1.12137404, -1.12573737, -1.13010069, &
&        -1.13446401, -1.13882734, -1.14319066, -1.14755398, -1.15191731, &
&        -1.15628063, -1.16064395, -1.16500728, -1.16937060, -1.17373392, &
&        -1.17809725, -1.18246057, -1.18682389, -1.19118721, -1.19555054, &
&        -1.19991386, -1.20427718, -1.20864051, -1.21300383, -1.21736715, &
&        -1.22173048, -1.22609380, -1.23045712, -1.23482045, -1.23918377, &
&        -1.24354709, -1.24791042, -1.25227374, -1.25663706, -1.26100038, &
&        -1.26536371, -1.26972703, -1.27409035, -1.27845368, -1.28281700, &
&        -1.28718032, -1.29154365, -1.29590697, -1.30027029, -1.30463362, &
&        -1.30899694, -1.31336026, -1.31772359, -1.32208691, -1.32645023, &
&        -1.33081355, -1.33517688, -1.33954020, -1.34390352, -1.34826685, &
&        -1.35263017, -1.35699349, -1.36135682, -1.36572014, -1.37008346, &
&        -1.37444679, -1.37881011, -1.38317343, -1.38753676, -1.39190008, &
&        -1.39626340, -1.40062672, -1.40499005, -1.40935337, -1.41371669, &
&        -1.41808002, -1.42244334, -1.42680666, -1.43116999, -1.43553331, &
&        -1.43989663, -1.44425996, -1.44862328, -1.45298660, -1.45734993, &
&        -1.46171325, -1.46607657, -1.47043989, -1.47480322, -1.47916654, &
&        -1.48352986, -1.48789319, -1.49225651, -1.49661983, -1.50098316, &
&        -1.50534648, -1.50970980, -1.51407313, -1.51843645, -1.52279977, &
&        -1.52716310, -1.53152642, -1.53588974, -1.54025306, -1.54461639, &
&        -1.54897971, -1.55334303, -1.55770636, -1.56206968, -1.56643300, &
&        -1.57079633]

RPI=2.0*ASIN(1.0)
R=8.3145
RDAY=86400.0
RMD=28.9644
RSIYEA=365.25*RDAY*2.0*RPI/6.283076
RSIDAY=RDAY/(1.0+RDAY/RSIYEA)
RA=6371229.0
ROMEGA=2.0*RPI/RSIDAY
RD=(1000.0*R)/RMD
RG=9.80665

IF((KTESTCASE == 41) .OR. (KTESTCASE == 42)) THEN

  ZLONC=RPI/9.0
  ZLATC=2.0*RPI/9.0

! Combinatory calculus

  BINOMIAL(0,0)=1.0
  DO JN=1,4*ZN+2
    BINOMIAL(JN,0)=1.0
    DO JK=1,JN
      IF (JK .EQ. JN) THEN
        BINOMIAL(JN,JK)=1.0
      ELSE
        BINOMIAL(JN,JK)=1.0
        DO JI=0,JK-1
          BINOMIAL(JN,JK)=(BINOMIAL(JN,JK)*(JN-JI))/(JI+1)
        ENDDO
      ENDIF
    ENDDO
  ENDDO

  GAM(0)=SQRT(RPI)
  DO JN=1,2*ZN+1
    GAM(JN)=(BINOMIAL(2*JN,JN)*SQRT(RPI))/(4**JN)
  ENDDO

! Temperature & Geopotential, vert. profiles

  ZLAPS = RD*ZGAMMA/RG

  DO JLEV=1,NLEV
    ZTVERT(JLEV)=ZT0*(VETAF(JLEV)**ZLAPS)
    ZPHIVERT(JLEV)=((ZT0*RG)/ZGAMMA)*(1.0-(VETAF(JLEV)**ZLAPS))
  ENDDO

! Begin the field computation

  DO JLAT=1,NLAT
    ZCOSLAT=cos(GELAT(JLAT))
    ZSINLAT=sin(GELAT(JLAT))

    F1=(ZCOSLAT**(2.0*ZN+1.0))/(2.0*ZN+1.0)
    F3=(GAM(ZN+1)*SQRT(RPI))/(2.0*ZN+1.0)
    DO JN=1,ZN
      F1=F1 + (((-1.0)**JN)/(2.0*(JN+ZN)+1.0))* &
&	(ZCOSLAT**(2.0*(JN+ZN)+1.0))*BINOMIAL(ZN,JN)
      F3=F3 + (((-1.0)**JN)/(2.0*(JN+ZN)+1.0))* &
&	SQRT(RPI)*BINOMIAL(ZN,JN)*GAM(ZN+JN+1)
    ENDDO

    F2=(ZSINLAT**(4.0*ZN+2.0))/(4.0*ZN+2.0)
    F4=2.0/((4.0*ZN+2.0)*(4.0*ZN+3.0))
    DO JN=1,2*ZN-1
      F2=F2 + (((-1.0)**JN)/(2.0*(JN+2.0*ZN+1.0)))* &
&	(ZSINLAT**(2.0*(JN+2.0*ZN+1.0)))*BINOMIAL(2*ZN-1,JN)
      F4=F4 + ((2.0*(-1.0)**JN)/((2.0*(2.0*ZN+JN+1.0))* &
&	(2.0*(JN+2.0*ZN+1.0)+1.0)))*BINOMIAL(2*ZN-1,JN)
    ENDDO

!   Prescribe wind and temperature

    DO JLEV=1,NLEV
      ZUSTAR=ZU0*log(VETAF(JLEV))*exp(-((log(VETAF(JLEV))/ZB)**2.0))

      ZUSTAR_PRIME=ZU0*exp(-((log(VETAF(JLEV))/ZB)**2.0)) * &
&	((2.0*(log(VETAF(JLEV))/ZB)**2.0)-1.0)

      ZU(JLAT,JLEV) = (-1)*ZUSTAR * &
&	(sin(2.0*GELAT(JLAT))**(2.0*ZN))

      ZV(JLAT,JLEV) = 0.00

      ZPHI_PRIME(JLAT,JLEV) = ZUSTAR*(ROMEGA*RA*(4.0**ZN)*(F3-2.0*F1) + &
&	ZUSTAR*(16.0**ZN)*(0.50*F4-F2))

      ZT(JLAT,JLEV) = ZTVERT(JLEV) + &
&	(ZUSTAR_PRIME/RD)*(ROMEGA*RA*(4.0**ZN)*(F3-2.0*F1) + &
&	ZUSTAR*(16.0**ZN)*(F4-2.0*F2))

      ZPHI_F(JLAT,JLEV) = ZPHIVERT(JLEV) + ZPHI_PRIME(JLAT,JLEV)

    ENDDO
  ENDDO

  DO JLAT = 1,NLAT
    DO JLEV = 1, NLEV
      ZQ(JLAT,JLEV) = 0.00
    ENDDO
  ENDDO

  IF((KTESTCASE == 42)) THEN
!   Compute virtual temperature

    DO JLAT = 1,NLAT
      DO JLEV = 1, NLEV
        ZTV(JLAT,JLEV) = ZT(JLAT,JLEV)
      ENDDO
    ENDDO

    DO JOPTI = 1,10
      DO JLAT = 1,NLAT
        DO JLEV = 1, NLEV
          ZTI(JLAT,JLEV) = ZT(JLAT,JLEV)

          ZES(JLAT,JLEV) = 611.210*exp((17.670*(ZTI(JLAT,JLEV)-273.150)) / &
&           (ZTI(JLAT,JLEV)-29.650))

          ZWS(JLAT,JLEV) = (0.6220*ZES(JLAT,JLEV))/(101325.0*VETAF(JLEV) - &
&           ZES(JLAT,JLEV))

          IF (VETAF(JLEV) .LE. 0.10) THEN
            ZRH(JLEV) = 0.0
          ELSEIF ((VETAF(JLEV) .GT. 0.10) .AND. &
&                 (VETAF(JLEV) .LE. 0.30)) THEN
            ZRH(JLEV) = (0.70*ZRH0/2.0) * &
&             (10.0*VETAF(JLEV)-1.0)
          ELSEIF ((VETAF(JLEV) .GT. 0.30) .AND. &
&                 (VETAF(JLEV) .LE. 0.80)) THEN
            ZRH(JLEV) = 0.70*ZRH0
          ELSE
            ZRH(JLEV) = 0.70*ZRH0 + (0.30*ZRH0/2.0) * &
&             (10.0*VETAF(JLEV)-8.0)
          ENDIF

          ZQ(JLAT,JLEV) = (ZWS(JLAT,JLEV)*ZRH(JLEV))/(ZWS(JLAT,JLEV)*ZRH(JLEV) + &
&           1.0)

          ZT(JLAT,JLEV)=ZTV(JLAT,JLEV)/(1.0+0.6080*ZQ(JLAT,JLEV))

        ENDDO
      ENDDO
    ENDDO
  ENDIF
ENDIF

CALL WRITE_FIELDS_TO_CSV(NLAT, NLEV, ZPHI_F, ZU, ZT, ZQ, FILENAME)

END SUBROUTINE COMPUTE_AND_WRITE_FIELDS

SUBROUTINE WRITE_FIELDS_TO_CSV(NLAT, NLEV, ZPHI_F, ZU, ZT, ZQ, FILENAME)
  IMPLICIT NONE

  INTEGER, PARAMETER :: INT_KIND = SELECTED_INT_KIND(18)  ! Use 18 or another appropriate value
  INTEGER(INT_KIND), INTENT(IN) :: NLAT, NLEV
  REAL(KIND=16), INTENT(IN) :: ZPHI_F(NLAT, NLEV), ZU(NLAT, NLEV), ZT(NLAT, NLEV), ZQ(NLAT, NLEV)
  INTEGER(INT_KIND) :: I, J
  CHARACTER(LEN=200) :: FILENAME
  INTEGER(INT_KIND), PARAMETER :: MAX_FILENAME_LEN = 200
  CHARACTER(LEN=255) :: HEADER
  INTEGER(INT_KIND) :: UNIT

  ! Open the file
  OPEN(UNIT=UNIT, FILE=FILENAME, STATUS="NEW")


  ! Define the header row for the CSV file (testing 1st and 2nd levels, 1-3rd lats)
  HEADER = "ILAT,ILEV,ZPHI_F,ZU,ZT,ZQ"
  ! Write the header row
  WRITE(UNIT, '(A)') HEADER

  DO I = 1, NLAT
    DO J = 1, 2
      
      WRITE(UNIT, '(I4, I4, F20.10, F20.10, F20.10, F20.10)') I-1, J-1, ZPHI_F(I, J), ZU(I, J), ZT(I, J), ZQ(I, J) ! LAT=I, LEV=J, using zero indexing

    END DO
  END DO

  ! Close the file
  CLOSE(UNIT)

END SUBROUTINE WRITE_FIELDS_TO_CSV